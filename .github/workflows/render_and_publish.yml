on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "**"

name: "Render and Publish Book"

jobs:
  bookdown-gitbook:
    name: Render book for GitHub Pages
    runs-on: macOS-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v3
      - name: "Install R"
        uses: r-lib/actions/setup-r@v2
      - name: "Install Pandoc"
        uses: r-lib/actions/setup-pandoc@v2
      - name: "Install R dependencies (and cache)"
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          needs: |
            rmarkdown
            bookdown
      - name: "Render book as GitBook"
        run: Rscript -e 'bookdown::render_book("index.Rmd", "bookdown::gitbook")'
      - name: "Upload artifact"
        uses: actions/upload-artifact@v3
        with:
          name: _book_gitbook
          path: _book/

  gitbook-publish:
      name: Publish book on GitHub Pages
      runs-on: ubuntu-latest
      needs: bookdown-gitbook
      steps:
        - name: "Checkout Repository"
          uses: actions/checkout@v3
        - name: "Download artifact"
          uses: actions/download-artifact@v3
          with:
            name: _book_gitbook
            path: _book
        - name: "Publish to GitHub Pages"
          uses: Cecilapp/GitHub-Pages-deploy@v3
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          with:
            email: fs-bcg@uni-bayreuth.de
            build_dir: _book/

  bookdown-pdf:
    name: Render book as PDF
    runs-on: macOS-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v3
      - name: "Install R"
        uses: r-lib/actions/setup-r@v2
      - name: "Install Pandoc"
        uses: r-lib/actions/setup-pandoc@v2
      - name: "Install TinyText"
        uses: r-lib/actions/setup-tinytex@v2
        env:
          # install full prebuilt version
          TINYTEX_INSTALLER: TinyTeX
      - name: "Install R dependencies (and cache)"
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache-version: 2
          needs: |
            rmarkdown
            bookdown
            tinytex
      - name: "Render book as PDF"
        run: Rscript -e 'bookdown::render_book("index.Rmd", "bookdown::pdf_book")'
      - name: "Upload artifact"
        uses: actions/upload-artifact@v3
        with:
          name: _book_pdf
          path: _book/